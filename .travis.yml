language: c

os:
  - osx
  - linux

env:
 global:
  - VERSION=1.1.1

before_install:
  - wget https://github.com/linux-test-project/lcov/releases/download/v1.13/lcov-1.13.tar.gz
  - tar xf lcov-1.13.tar.gz
  - sudo make -C lcov-1.13/ install

  # Install lcov
  - gem install coveralls-lcov

# set the compiler
compiler:
  - gcc

before_script:
  - lcov --directory . --zerocounters

script: 
  - sh coverage.sh
  - make lib
  - zip -r liblymui-${TRAVIS_OS_NAME}-${VERSION}.zip bin

after_success:
  - lcov --directory . --capture --output-file coverage.info
  - lcov --remove coverage.info 'tests/*' '/usr/*' 'test-library*' --output-file coverage.info
  - lcov --list coverage.info
  - coveralls-lcov  coverage.info

before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name ${USERNAME}
  - git config --local user.email ${EMAIL}
  - if [[ "$TRAVIS_OS_NAME" === "osx" ]]; then git tag -a v${VERSION} -m "Lymui build ${VERSION}"; fi
  - git push -q https://${GH_TOKEN}@github.com/MarcInthaamnouay/lymui --tags


notifications:
  email:
    on_success: never
    on_error: always

deploy:
  provider: releases
  api_key: ${GH_TOKEN}
  file:
    - liblymui-${TRAVIS_OS_NAME}-${VERSION}.zip
  skip_cleanup: true
  on:
    branch: master